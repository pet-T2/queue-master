<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DockerSpawner.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">queue-master</a> &gt; <a href="index.source.html" class="el_package">works.weave.socks.queuemaster</a> &gt; <span class="el_source">DockerSpawner.java</span></div><h1>DockerSpawner.java</h1><pre class="source lang-java linenums">package works.weave.socks.queuemaster;

import com.github.dockerjava.api.DockerClient;
import com.github.dockerjava.api.command.CreateContainerResponse;
import com.github.dockerjava.api.exception.DockerException;
import com.github.dockerjava.core.DockerClientBuilder;
import com.github.dockerjava.core.DockerClientConfig;
import com.github.dockerjava.core.command.PullImageResultCallback;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

@Component
<span class="fc" id="L17">public class DockerSpawner {</span>
<span class="fc" id="L18">    private final Logger logger = LoggerFactory.getLogger(this.getClass());</span>

	private DockerClient dc;
	private ExecutorService dockerPool;

<span class="fc" id="L23">	private String imageName = &quot;weaveworksdemos/worker&quot;;</span>
<span class="fc" id="L24">	private String imageVersion = &quot;latest&quot;;</span>
<span class="fc" id="L25">	private String networkId = &quot;weavedemo_backoffice&quot;;</span>
<span class="fc" id="L26">	private int poolSize = 50;</span>

	public void init() {
<span class="nc bnc" id="L29" title="All 2 branches missed.">		if (dc == null) {</span>
<span class="nc" id="L30">			DockerClientConfig.DockerClientConfigBuilder builder = DockerClientConfig.createDefaultConfigBuilder();</span>

<span class="nc" id="L32">            DockerClientConfig config = builder.build();</span>
<span class="nc" id="L33">            dc = DockerClientBuilder.getInstance(config).build();</span>

<span class="nc" id="L35">            dc.pullImageCmd(imageName).withTag(imageVersion).exec(new PullImageResultCallback()).awaitSuccess();</span>
		}
<span class="nc bnc" id="L37" title="All 2 branches missed.">		if (dockerPool == null) {</span>
<span class="nc" id="L38">			dockerPool = Executors.newFixedThreadPool(poolSize);</span>
		}
<span class="nc" id="L40">	}</span>

	public void spawn() {
<span class="nc" id="L43">		dockerPool.execute(new Runnable() {</span>
		    public void run() {
<span class="nc" id="L45">				logger.info(&quot;Spawning new container&quot;);</span>
				try {
<span class="nc" id="L47">					CreateContainerResponse container = dc.createContainerCmd(imageName + &quot;:&quot; + imageVersion).withNetworkMode(networkId).withCmd(&quot;ping&quot;, &quot;rabbitmq&quot;).exec();</span>
<span class="nc" id="L48">					String containerId = container.getId();</span>
<span class="nc" id="L49">					dc.startContainerCmd(containerId).exec();</span>
<span class="nc" id="L50">					logger.info(&quot;Spawned container with id: &quot; + container.getId() + &quot; on network: &quot; + networkId);</span>
					// TODO instead of just sleeping, call await on the container and remove once it's completed.
<span class="nc" id="L52">					Thread.sleep(40000);</span>
					try {
<span class="nc" id="L54">						dc.stopContainerCmd(containerId).exec();</span>
					}
<span class="nc" id="L56">					catch (DockerException e) {</span>
<span class="nc" id="L57">						logger.info(&quot;Container already stopped. (This is expected).&quot;);</span>
<span class="nc" id="L58">					}</span>
<span class="nc" id="L59">					dc.removeContainerCmd(containerId).exec();</span>
<span class="nc" id="L60">					logger.info(&quot;Removed Container:&quot; + containerId);</span>
<span class="nc" id="L61">				} catch (Exception e) {</span>
<span class="nc" id="L62">					logger.error(&quot;Exception trying to launch/remove worker container. &quot; + e);</span>
<span class="nc" id="L63">				}</span>
<span class="nc" id="L64">		    }</span>
		});
<span class="nc" id="L66">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>